<!DOCTYPE HTML>
<html>

<head>
    <title>this is a test</title>
    <meta charset="UTF-8">
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
    <script src="ImageBit.js"></script> 

    <link rel="stylesheet" type="text/css" href="MsetStyles.css">

    <script>
        var canvas1;
        var canvas2;
        var mouseWindowHeight, mouseWindowWidth;
        var oldX, oldY;
        var op;
        var ctx1, ctx2;
        var mousePosx, mousePosy;
        var imgDt;
        var worker = new Array();


        function relMouseCoords(e) {

            var totalOffsetX = 0;
            var totalOffsetY = 0;
            var canvasX = 0;
            var canvasY = 0;
            var currentElement = this;

            do {
                totalOffsetX += currentElement.offsetLeft - currentElement.scrollLeft;
                totalOffsetY += currentElement.offsetTop - currentElement.scrollTop;
            }
            while (currentElement = currentElement.offsetParent)

            canvasX = event.pageX - totalOffsetX;
            canvasY = event.pageY - totalOffsetY;

            return { x: canvasX, y: canvasY }

        }

        HTMLCanvasElement.prototype.relativeMouseCoords = relMouseCoords;


        function init() {

            canvas1 = document.getElementById("canvas1");
            ctx1 = canvas1.getContext("2d");
            canvas2 = document.getElementById("canvas2");
            ctx2 = canvas2.getContext("2d");
          
            canvas1.width = $("#canvasContainer").width();
            canvas1.height = $("#canvasContainer").height();
            canvas2.width = $("#canvasContainer").width();
            canvas2.height = $("#canvasContainer").height();
            
            mouseWindowWidth = canvas1.width / 5 + 1;
            mouseWindowHeight = canvas1.height / 5 + 1;

            $("#out1").val(-2.5) ;
            $("#out2").val(1.2);
            $("#out3").val(1);
            $("#iterationMultiplier").val(1);
            $("#threshadd").val(0);

            imgDt = ctx1.createImageData(canvas1.width, canvas1.height);
            paintThreadSet(imgDt);


            /*******************************************************
            /* Clear the sprite when the mouse leaves the canvas
            /*******************************************************/

            canvas2.onmouseleave = function (e) {
                ctx2.clearRect(0, 0, canvas2.width, canvas2.height);
             }
            
            /*******************************************************
            /* Redraws the sprite when the mouse moves
            /*******************************************************/

            canvas2.onmousemove = function (e) {
                
                var relativeCoords = canvas2.relativeMouseCoords(e);
                ctx2.clearRect(oldX - mouseWindowWidth / 2 - 3, oldY - mouseWindowHeight / 2 - 3, mouseWindowWidth + 6, mouseWindowHeight + 6);

                ctx2.fillStyle = "rgba(150, 240, 100, 0.2)";
                ctx2.fillRect(relativeCoords.x - mouseWindowWidth / 2, relativeCoords.y - mouseWindowHeight / 2, mouseWindowWidth, mouseWindowHeight);

                oldX = relativeCoords.x; oldY = relativeCoords.y;

            };

            /*******************************************************
            /* Resizes when the mouse wheel scrolls
            /*******************************************************/

            canvas2.onmousewheel = function (e) {

                var relativeCoords = canvas2.relativeMouseCoords(e);

                var delta = Math.max(-1, Math.min(1, e.wheelDelta));
                mouseWindowHeight = (1 + 0.2 * delta) * mouseWindowHeight;
                mouseWindowWidth = (1 + 0.2 * delta) * mouseWindowWidth;

                ctx2.clearRect(0,0,canvas2.width, canvas2.height);
                ctx2.fillStyle = "rgba(150, 240, 100, 0.2)";
                ctx2.fillRect(relativeCoords.x - mouseWindowWidth / 2, relativeCoords.y - mouseWindowHeight / 2, mouseWindowWidth, mouseWindowHeight);

                oldX = relativeCoords.x; oldY = relativeCoords.y;

                return false; //this prevents the default scrolling
            }
            
            /*******************************************************
            /* Simply stores the position of the mouse on click to check for drag on mouseup
            /*******************************************************/
            canvas2.onmousedown = function (e) {

                relativeCoords = canvas2.relativeMouseCoords(e);
                mousePosx = relativeCoords.x; 
                mousePosy = relativeCoords.y;
            }

            /*******************************************************
            /* triggers a redraw depending on drag or click. 
            /*******************************************************/

            canvas2.onmouseup = function (e) {

                var imgDt;
                var relativeCoords = canvas2.relativeMouseCoords(e);
                var currX1 = parseFloat(document.getElementById("out1").value);
                var currY1 = parseFloat(document.getElementById("out2").value);
                var currX2 = parseFloat(document.getElementById("out3").value);
                var xSpan = currX2 - currX1;
                var ySpan = xSpan * canvas2.height / canvas2.width;


                if (relativeCoords.x != mousePosx || relativeCoords.y != mousePosy) {
                    var x1 = currX1 - (relativeCoords.x - mousePosx) / canvas2.width * xSpan;
                    var y1 = currY1 + (relativeCoords.y - mousePosy) / canvas2.height * ySpan;
                    var x2 = x1 + xSpan;
                    // we have drag so take a snapshot of the image and shift it so dont clear it all. 
                    imgDt = ctx1.getImageData(0, 0, canvas1.width, canvas1.height);
                    ctx1.clearRect(0, 0, canvas1.width, canvas1.height);
                    ctx1.putImageData(imgDt, relativeCoords.x - mousePosx, relativeCoords.y - mousePosy);
                }

                else {
                    var x1 = currX1 + (relativeCoords.x - mouseWindowWidth / 2) / canvas2.width * xSpan;
                    var y1 = currY1 - (relativeCoords.y - mouseWindowHeight / 2) / canvas2.height * ySpan;
                    var x2 = currX1 + (relativeCoords.x + mouseWindowWidth / 2) / canvas2.width * xSpan;

                    ctx1.clearRect(0, 0, canvas1.width, canvas1.height);
                }

                document.getElementById("out1").value = x1;
                document.getElementById("out2").value = y1;
                document.getElementById("out3").value = x2;

                paintThreadSet();
                

            } //onmouseup

        }   // init

        //*******************************************************
        // Re-runs the same picture allowing user to modify some settings
        //******************************************************
        recalculate = function () {
            ctx1.clearRect(0, 0, canvas1.width, canvas1.height);
            paintThreadSet();
        }


        //*******************************************************
        // Presets
        //******************************************************
        preset1 = function () {
            $("#out1").val(-0.1691381123916208);
            $("#out2").val(0.6505404350243774);
            $("#out3").val(-0.16913809694267987);
            $("#iterationMultiplier").val(4);
            ctx1.clearRect(0, 0, canvas1.width, canvas1.height);
            paintThreadSet();
        }



        /*******************************************************
        /* Triggers the computation and drawing of the Set
        /*******************************************************/
        
        function paintThreadSet() {

           
            var x1 = parseFloat(document.getElementById("out1").value);
            var y1 = parseFloat(document.getElementById("out2").value);
            var x2 = parseFloat(document.getElementById("out3").value);
            var maxMult = parseFloat(document.getElementById("iterationMultiplier").value);
            var maxiter = Math.abs(200 * Math.log(x2 - x1)) * maxMult;
            document.getElementById("out5").value = maxiter;

            var threshadd = parseFloat(document.getElementById("threshadd").value);
            var threshold = 10 + Math.abs(Math.log(x2 - x1)) + threshadd;
            document.getElementById("out6").value = threshold;

            var numworkers = 5;
            var xpixel = 0, ypixel = 0;  // keeps count of the index of the subimage
            
           
            for (var i = 0; i < numworkers; i++) {

                var subwidth = Math.floor(canvas1.width / numworkers);
                if (i == numworkers - 1) //if we have reached the last image, take all remaining pixels regardless of rounding
                    subwidth = canvas1.width - i * subwidth;

                for (var j = 0; j < numworkers; j++) {

                    var subheight = Math.floor(canvas1.height / numworkers);
                    if (j == numworkers-1) //if we have reached the last image, take all remaining pixels regardless of rounding
                        subheight = canvas1.height - j * subheight;

                    // take a snapshot of the subimage. 
                    var imgDt = ctx1.getImageData(xpixel, ypixel, subwidth, subheight);

                    var subx1 = x1 + (x2 - x1) / canvas1.width * xpixel;
                    var suby1 = y1 - (x2 - x1) / canvas1.width * ypixel;
                    var subx2 = x1 + (x2 - x1) / canvas1.width * (xpixel + subwidth);
                    var imb = new ImageBit(imgDt, subwidth, subheight, subx1, suby1 , subx2);

                    //construct message to pass to the worker
                    var workerMessage = {
                        workerID: i*numworkers+j,
                        maxiter: maxiter,
                        threshold: threshold,
                        imgbit: imb,
                        px1: xpixel,
                        py1: ypixel,
                    };

                    //create the worker. 
                    var ind = numworkers * i + j;
                    if (worker[ind])
                        worker[ind].terminate();
                    worker[ind] = new Worker("MsetWorker.js");

                    //Start the worker by posting the data. This triggers the "onmessage" function in the worker file. 
                    worker[ind].postMessage(workerMessage);

                    //registers the callback function 
                    worker[ind].onmessage = workerCallback;
                    
                    ypixel = ypixel + subheight;
                } // for j loop

                ypixel = 0; // reset the y position for each iteration of x
                xpixel = xpixel + subwidth; // keep tab of the current subimage position
            } // for i loop


            //defines the call back function, which determinse what should happen when the workers finish. In this case, paint the image. 
            function workerCallback(e) {
                ctx1.putImageData(e.data.imgbit.imgData, Math.floor(e.data.px1), Math.floor(e.data.py1));
            }

        } //paintThreadSet

    </script>

</head>


<body onload="init();">
    <div style="width: 760px">
        <div id="canvasContainer" style="position:relative; height:550px; width:800px" >
            <canvas id="canvas1"></canvas>
            <canvas id="canvas2"></canvas>
        </div>

        <div class="item_line">
            <button onclick="recalculate()">Recalculate</button>
            <label style="margin-left: 50px">X1</label>
            <input id="out1"; >
            <label >Y1</label>
            <input id="out2"; >
            <label >Y2</label>
            <input id="out3"; >
            <label >MaxMult</label>
            <input id="iterationMultiplier" onchange="recalculate()">
            <label >maxiter</label>
            <input id="out5" >
            <label >threshold</label>
            <input id="out6" onchange="recalculate()">
            <label>threshold offset</label>
            <input id="threshadd" >
        </div>
        <div class="item_line presets">
            <button onclick="preset1()">Preset 1</button>
            
        </div>
    </div>
</body>
</html>
